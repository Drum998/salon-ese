{% extends "base.html" %}

{% block page_title %}Book Appointment{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">Book an Appointment</h3>
            </div>
            <div class="card-body">
                {% if not form.stylist_id.choices %}
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-exclamation-triangle"></i> No Stylists Available</h5>
                        <p>There are currently no stylists available for booking. Please contact the salon administrator to set up stylist accounts.</p>
                    </div>
                {% elif not form.services[0].service_id.choices %}
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-exclamation-triangle"></i> No Services Available</h5>
                        <p>There are currently no services available for booking. Please contact the salon administrator to set up services.</p>
                    </div>
                {% else %}
                    {# Show pre-filled parameters indicator #}
                    {% if request.args.get('date') or request.args.get('time') or request.args.get('stylist_id') %}
                        <div class="alert alert-info">
                            <h6><i class="fas fa-calendar-check"></i> Pre-filled from Calendar</h6>
                            <div class="row">
                                {% if request.args.get('date') %}
                                    <div class="col-md-4">
                                        <strong>Date:</strong> {{ request.args.get('date') }}
                                    </div>
                                {% endif %}
                                {% if request.args.get('time') %}
                                    <div class="col-md-4">
                                        <strong>Time:</strong> {{ request.args.get('time') }}
                                    </div>
                                {% endif %}
                                {% if request.args.get('stylist_id') %}
                                    <div class="col-md-4">
                                        <strong>Stylist:</strong> Pre-selected
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    {# Salon Hours Information #}
                    {% if salon_settings %}
                        <div class="alert alert-info">
                            <h6><i class="fas fa-clock"></i> Salon Hours</h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <small>
                                        {% for day, hours in salon_settings.opening_hours.items() %}
                                            <strong>{{ day.title() }}:</strong> 
                                            {% if hours.closed %}
                                                <span class="text-muted">Closed</span>
                                            {% else %}
                                                {{ hours.open }} - {{ hours.close }}
                                            {% endif %}
                                            {% if not loop.last %} | {% endif %}
                                        {% endfor %}
                                    </small>
                                </div>
                                <div class="col-md-4 text-end">
                                    {% if salon_settings.emergency_extension_enabled %}
                                        <span class="badge bg-warning">Emergency Extensions Enabled</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.stylist_id.label(class="form-label") }}
                                    {{ form.stylist_id(class="form-select") }}
                                    {% if form.stylist_id.errors %}
                                        <div class="text-danger">
                                            {% for error in form.stylist_id.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {# Show customer dropdown only for non-customer users #}
                                    {% if not current_user.has_role('customer') %}
                                        {{ form.customer_id.label(class="form-label") }}
                                        {{ form.customer_id(class="form-select") }}
                                        {% if form.customer_id.errors %}
                                            <div class="text-danger">
                                                {% for error in form.customer_id.errors %}
                                                    <small>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        {{ form.customer_id() }} {# hidden field #}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div id="services-list">
                            <label class="form-label">Services</label>
                            {% for subform in form.services %}
                            <div class="row service-row mb-2" data-index="{{ loop.index0 }}">
                                {{ subform.csrf_token }}
                                <div class="col-md-4">
                                    {{ subform.service_id(class="form-select") }}
                                    {% if subform.service_id.errors %}
                                        <div class="text-danger">
                                            {% for error in subform.service_id.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-2">
                                    {{ subform.duration(class="form-control", placeholder="Duration (min)") }}
                                    {% if subform.duration.errors %}
                                        <div class="text-danger">
                                            {% for error in subform.duration.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-2">
                                    {{ subform.waiting_time(class="form-control", placeholder="Waiting (min)") }}
                                    {% if subform.waiting_time.errors %}
                                        <div class="text-danger">
                                            {% for error in subform.waiting_time.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        {{ subform.use_stylist_timing(class="form-check-input") }}
                                        {{ subform.use_stylist_timing.label(class="form-check-label") }}
                                    </div>
                                    {% if subform.use_stylist_timing.errors %}
                                        <div class="text-danger">
                                            {% for error in subform.use_stylist_timing.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-1 d-flex align-items-center">
                                    <button type="button" class="btn btn-danger btn-sm remove-service" title="Remove Service" {% if loop.length == 1 %}disabled{% endif %}><i class="fas fa-minus"></i></button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            <button type="button" class="btn btn-secondary btn-sm" id="add-service"><i class="fas fa-plus"></i> Add Service</button>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.appointment_date.label(class="form-label") }}
                                    {{ form.appointment_date(class="form-control", type="date") }}
                                    {% if form.appointment_date.errors %}
                                        <div class="text-danger">
                                            {% for error in form.appointment_date.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.start_time.label(class="form-label") }}
                                    {{ form.start_time(class="form-select") }}
                                    {% if form.start_time.errors %}
                                        <div class="text-danger">
                                            {% for error in form.start_time.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {# Emergency Extension Field #}
                        {% if salon_settings and salon_settings.emergency_extension_enabled %}
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.emergency_extension(class="form-check-input") }}
                                    {{ form.emergency_extension.label(class="form-check-label") }}
                                    <small class="form-text text-muted d-block">
                                        Allow appointment to extend beyond normal salon hours if necessary
                                    </small>
                                </div>
                                {% if form.emergency_extension.errors %}
                                    <div class="text-danger">
                                        {% for error in form.emergency_extension.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.customer_phone.label(class="form-label") }}
                                    {{ form.customer_phone(class="form-control", placeholder="Optional - for notifications") }}
                                    {% if form.customer_phone.errors %}
                                        <div class="text-danger">
                                            {% for error in form.customer_phone.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.customer_email.label(class="form-label") }}
                                    {{ form.customer_email(class="form-control", placeholder="Optional - for notifications") }}
                                    {% if form.customer_email.errors %}
                                        <div class="text-danger">
                                            {% for error in form.customer_email.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control", rows="3", placeholder="Any special requests or notes...") }}
                            {% if form.notes.errors %}
                                <div class="text-danger">
                                    {% for error in form.notes.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="d-grid">
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Booking Information</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li><i class="fas fa-clock text-primary"></i> Appointments are available during salon opening hours</li>
                    <li><i class="fas fa-calendar text-primary"></i> You can book appointments up to 30 days in advance</li>
                    <li><i class="fas fa-phone text-primary"></i> You'll receive confirmation via email or phone</li>
                    <li><i class="fas fa-exclamation-triangle text-warning"></i> Please arrive 10 minutes before your appointment time</li>
                    {% if salon_settings and salon_settings.emergency_extension_enabled %}
                        <li><i class="fas fa-exclamation-circle text-warning"></i> Emergency extensions may be available for special circumstances</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Set minimum date to today
// Add/remove service rows dynamically
// Update service choices based on selected stylist
// Update time slots based on date and stylist

document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.querySelector('input[type="date"]');
    const today = new Date().toISOString().split('T')[0];
    dateInput.setAttribute('min', today);

    // Add/remove service rows
    const servicesList = document.getElementById('services-list');
    const addServiceBtn = document.getElementById('add-service');
    
    servicesList.addEventListener('click', function(e) {
        if (e.target.closest('.remove-service')) {
            const row = e.target.closest('.service-row');
            if (servicesList.querySelectorAll('.service-row').length > 1) {
                row.remove();
            }
        }
    });
    
    // Update service choices when stylist is selected
    const stylistSelect = document.querySelector('select[name="stylist_id"]');
    if (stylistSelect) {
        stylistSelect.addEventListener('change', function() {
            const stylistId = this.value;
            if (stylistId) {
                updateServiceChoices(stylistId);
                updateTimeSlots();
            }
        });
    }
    
    // Update time slots when date changes
    if (dateInput) {
        dateInput.addEventListener('change', function() {
            updateTimeSlots();
        });
    }
    
    function updateTimeSlots() {
        const selectedDate = dateInput.value;
        const selectedStylist = stylistSelect ? stylistSelect.value : null;
        
        if (!selectedDate) return;
        
        // Show loading state
        const timeSelect = document.querySelector('select[name="start_time"]');
        const originalOptions = timeSelect.innerHTML;
        timeSelect.innerHTML = '<option value="">Loading available times...</option>';
        
        // Fetch available slots
        const url = `/appointments/api/available-slots?date=${selectedDate}`;
        if (selectedStylist) {
            url += `&stylist_id=${selectedStylist}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error fetching available slots:', data.error);
                    timeSelect.innerHTML = originalOptions;
                    return;
                }
                
                // Clear and populate time slots
                timeSelect.innerHTML = '<option value="">Select time...</option>';
                
                if (data.slots && data.slots.length > 0) {
                    data.slots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot;
                        option.textContent = slot;
                        timeSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No available times';
                    option.disabled = true;
                    timeSelect.appendChild(option);
                }
                
                // Show salon hours info if available
                if (data.salon_hours) {
                    showSalonHoursInfo(data.salon_hours);
                }
            })
            .catch(error => {
                console.error('Error updating time slots:', error);
                timeSelect.innerHTML = originalOptions;
            });
    }
    
    function showSalonHoursInfo(hours) {
        // You can add a small info display here if needed
        console.log('Salon hours for selected date:', hours);
    }
    
    function updateServiceChoices(stylistId) {
        // Fetch services for the selected stylist
        fetch(`/appointments/api/stylist-services/${stylistId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error fetching stylist services:', data.error);
                    return;
                }
                
                // Update all service select dropdowns
                const serviceSelects = document.querySelectorAll('select[name*="service_id"]');
                serviceSelects.forEach(select => {
                    const currentValue = select.value;
                    
                    // Clear existing options
                    select.innerHTML = '<option value="">Select service...</option>';
                    
                    // Add new options based on stylist permissions
                    data.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.id;
                        option.textContent = `${service.name} (£${service.price}) - ${service.duration}min`;
                        select.appendChild(option);
                    });
                    
                    // Try to restore the previously selected value if it's still available
                    if (currentValue) {
                        const option = select.querySelector(`option[value="${currentValue}"]`);
                        if (option) {
                            select.value = currentValue;
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error updating service choices:', error);
            });
    }
    
    addServiceBtn.addEventListener('click', function() {
        const lastRow = servicesList.querySelector('.service-row:last-of-type');
        if (!lastRow) return;
        
        // Get the current number of service rows to calculate the new index
        const currentRows = servicesList.querySelectorAll('.service-row');
        const newIndex = currentRows.length;
        
        // Create a new row by cloning the last one
        const newRow = lastRow.cloneNode(true);
        
        // Get the CSRF token from the main form
        const mainCsrfToken = document.querySelector('input[name="csrf_token"]').value;
        
        // Update the form field names to use the correct index
        const serviceSelect = newRow.querySelector('select[name*="service_id"]');
        const durationInput = newRow.querySelector('input[name*="duration"]');
        const waitingInput = newRow.querySelector('input[name*="waiting_time"]');
        const stylistTimingCheckbox = newRow.querySelector('input[name*="use_stylist_timing"]');
        const csrfInput = newRow.querySelector('input[name*="csrf_token"]');
        
        if (serviceSelect) {
            serviceSelect.name = `services-${newIndex}-service_id`;
            serviceSelect.id = `services-${newIndex}-service_id`;
        }
        if (durationInput) {
            durationInput.name = `services-${newIndex}-duration`;
            durationInput.id = `services-${newIndex}-duration`;
        }
        if (waitingInput) {
            waitingInput.name = `services-${newIndex}-waiting_time`;
            waitingInput.id = `services-${newIndex}-waiting_time`;
        }
        if (stylistTimingCheckbox) {
            stylistTimingCheckbox.name = `services-${newIndex}-use_stylist_timing`;
            stylistTimingCheckbox.id = `services-${newIndex}-use_stylist_timing`;
        }
        if (csrfInput) {
            csrfInput.name = `services-${newIndex}-csrf_token`;
            csrfInput.id = `services-${newIndex}-csrf_token`;
            csrfInput.value = mainCsrfToken;
        }
        
        // Clear the values
        if (serviceSelect) serviceSelect.selectedIndex = 0;
        if (durationInput) durationInput.value = '';
        if (waitingInput) waitingInput.value = '';
        if (stylistTimingCheckbox) stylistTimingCheckbox.checked = false;
        
        // Update the data-index attribute
        newRow.setAttribute('data-index', newIndex);
        
        servicesList.appendChild(newRow);
    });
});
</script>
{% endblock %} 